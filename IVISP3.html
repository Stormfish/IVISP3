<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Smoothing</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
    <script>
        var el=[];
        var averages=[];

        var dataSet;
        var dataSetLoaded=false;
        var VV;
        var VVLoaded=false;
        var KV; 
        var KVLoaded=false; 
        var hoursShown = 24; 

        d3.csv("http://stormfish.github.io/IVISP3/Data/30-1001-EL-used.csv", function(data) {
            dataSet=data;
            console.log(dataSet);
        });
        d3.csv("http://stormfish.github.io/IVISP3/Data/30-1001-VV-used.csv", function(data) {
            VV=data;
            console.log(VV);
        });
        d3.csv("http://stormfish.github.io/IVISP3/Data/30-1001-KV-used.csv", function(data) {
            KV=data;
            console.log(KV);
        });

        function getValues(data){
            var year = 2014; 
            var month = 06; 

            cTime = new Date();
            var day = cTime.getDate(); 
            var HH=cTime.getHours();
            var MM=cTime.getMinutes();

            var valList = []; 
            for(var j = 0; j<data.length; j++){
                var d = dataSet[j];
                if(d.year==year && d.day==day && d.HH==HH){
                    for(var k = 0; k<24; k++){
                        valList.push(dataSet[j-24+k].energy);
                    }
                    break;
                }
            }
            el = valList; 
            return valList;
        }

        function valueConversion(val){
            return 100+40*val;
        }
        function getRadiouses(data){
            var v = [];
            var avg = getAverages(data);
            var vv = getValues(data);

            for(var i=0; i<hoursShown; i++){
                v[i]=150+(vv[i]-avg[i])*100;
            }
            return v; 
        }

        function getAverages(data){
            var year = 2014; 
            var month = 06; 

            cTime = new Date();
            var day = cTime.getDate(); 
            var HH=cTime.getHours();
            var MM=cTime.getMinutes();

            var historyLength = 3; 
            for(var iHistory = 0; iHistory<24; iHistory++){
                averages[iHistory]=0;
            }

            for(var j = 0; j<data.length; j++){
                var d = dataSet[j];
                if(d.year==year && d.day==day && d.HH==HH){
                    for(var k = 0; k<24*historyLength; k++){
                        averages[k%24]+=dataSet[j-24*historyLength+k].energy/historyLength;
                        //valList.push(dataSet[j-24*historyLength+k].energy);
                    }
                    break;
                }
            }
            return averages;
        }
    </script>

    <link rel="stylesheet" href="paperjs/examples/css/style.css">

    <script type="text/javascript" src="paperjs/dist/paper-full.js"></script>
    
    <script type="text/paperscript" canvas="canvas">
        var hoursShown = 24; 
        var eRadious = 250;

        var width, height, center;
        var points = 10;
        var smooth = true;
        var path = new Path({
            fillColor: 'black'
        });
        var mousePos = view.center / 2;
        var pathHeight = mousePos.y;

        var VVAvgPath = new Path({
        //    strokeColor:'red',
            fillColor:'red',
            closed:'true',
            opacity:0.8
        });
        var VVPath = new Path({
       //     strokeColor:'red',
            fillColor:new Color(0.5,0,0),
            closed:'true'
        });

        var KVAvgPath = new Path({
        //    strokeColor:'red',
            fillColor:'blue',
            closed:'true',
            opacity:0.8
        });
        var KVPath = new Path({
        //    strokeColor:'red',
            fillColor:new Color(0,0,0.5),
            closed:'true'
        });

        var elAvgPath = new Path({
        //    strokeColor:'red',
            fillColor:'green',
            closed:'true',
            opacity:0.8
        });

        var elPath = new Path({
        //    strokeColor:'red',
            fillColor:new Color(0.0, 0.5, 0.0),
            closed:'true'
        });
        //initializePath();
        
        function initializePath() {
            center = view.center;
            width = view.size.width;
            height = view.size.height / 2;
            
            var centerX = center._x;


            /*
                Initial Drawing stuff
            */
            var values = []; 
            if(dataSetLoaded){
                values=getValues(dataSet);
            } else{
                for(var i = 0; i<24; i++){
                    values.push(100);
                }
            }
            //Should turn the loop to get the right order of hours
            for(var j=0; j<hoursShown; j++){
                var cRadious = values[j];

                //draw VV consumption initials
                var cRadious = values[j];
                VVPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) );

                //draw Average VV consumption initials
                VVAvgPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) ); 
                
                //draw KV consumption initials
                KVPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) );

                //draw Average KV consumption initials
                KVAvgPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) ); 


                //draw power consumption initials
                elPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) );

                //draw Average power consumption initials
                elAvgPath.add( new Point( centerX+cRadious*Math.cos(2*Math.PI*(j/hoursShown)), height-cRadious*Math.sin(2*Math.PI*(j/hoursShown))) ); 

                 
            }

        }

        function onFrame(event) {
            //Initializations
            if (dataSetLoaded == false && typeof dataSet !== 'undefined') {
                el=getValues(dataSet);
                dataSetLoaded=true;
            }

            if(dataSetLoaded==true){
                var centerX = view.center._x;
                var h = view.size.height/2;
                el=getValues(dataSet);
                var r = getRadiouses(dataSet);
                //draw Power Consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = r[i];//valueConversion(el[i]);
                    elPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    elPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }
                //Draw average Power consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = 150;
                    elAvgPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    elAvgPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }
                r = getRadiouses(VV);
                //draw VV Consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = r[i]+200;//valueConversion(el[i]);
                    VVPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    VVPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }
                //Draw average VV consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = 350;
                    VVAvgPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    VVAvgPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }
                r = getRadiouses(KV);
                //draw KV Consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = r[i]+100;//valueConversion(el[i]);
                    KVPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    KVPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }
                //Draw average KV consumption
                for (var i = 0; i < hoursShown; i++) {
                    cRadious = 250;
                    KVAvgPath.segments[i].point.x= centerX+cRadious*Math.cos(2*Math.PI*(i/hoursShown));
                    KVAvgPath.segments[i].point.y= h-cRadious*Math.sin(2*Math.PI*(i/hoursShown));
                }


                if (smooth){
                    elPath.smooth();
                    elAvgPath.smooth();
                    KVPath.smooth();
                    KVAvgPath.smooth();
                    VVPath.smooth();
                    VVAvgPath.smooth();
                }
            }

        }

        function onMouseMove(event) {
            mousePos = event.point;
        }

        function onMouseDown(event) {
            smooth = !smooth;
            if (!smooth) {
                for (var i = 0, l = elPath.segments.length; i < l; i++) {
                    var segment = elPath.segments[i];
                    segment.handleIn = segment.handleOut = null;
                    segment = elAvgPath.segments[i];
                    segment.handleIn = segment.handleOut = null;

                    segment = KVPath.segments[i];
                    segment.handleIn = segment.handleOut = null;
                    segment = KVAvgPath.segments[i];
                    segment.handleIn = segment.handleOut = null;

                    segment = VVPath.segments[i];
                    segment.handleIn = segment.handleOut = null;
                    segment = VVAvgPath.segments[i];
                    segment.handleIn = segment.handleOut = null;                    
                }
            }
        }

        // Reposition the path whenever the window is resized:
        function onResize(event) {
            initializePath();
        }

    </script>
</head>
<body>
    <div id="header"> </div>
    <canvas style="background-color:black" id="canvas" resize> </canvas>
</body>
</html>
